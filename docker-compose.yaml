version: '3.9'

services:
  overview:
    image: nginx:alpine
    container_name: art-institut-overview
    restart: unless-stopped
    volumes:
      - ./web:/usr/share/nginx/html:ro
    networks:
      - proxy_net

  # Kimai (time tracking)
  kimai-db:
    image: mariadb:10.11
    container_name: art-institut-kimai-db
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${KIMAI_DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=${KIMAI_DB_NAME}
      - MYSQL_USER=${KIMAI_DB_USER}
      - MYSQL_PASSWORD=${KIMAI_DB_PASSWORD}
    volumes:
      - kimai_db_data:/var/lib/mysql

  kimai:
    image: kimai/kimai2:apache
    container_name: art-institut-kimai
    restart: unless-stopped
    depends_on:
      - kimai-db
    environment:
      - APP_ENV=prod
      - TRUSTED_PROXIES=0.0.0.0/0
      - TRUSTED_HOSTS=kimai.art-institut.de
      # Password must be URL-encoded for Kimai's startup (dbtest.php urldecode)
      - DATABASE_URL=mysql://kimai:${KIMAI_DB_PASSWORD_URLENC}@kimai-db:3306/kimai
      - MAILER_URL=${KIMAI_MAILER_DSN}
      - MAILER_FROM=${KIMAI_MAILER_FROM}
      # Optional: set admin seeding on first run
      # - ADMINMAIL=admin@art-institut.de
      # - ADMINPASS=change-me
      # Running behind reverse-proxy at subpath; Kimai works with subdir when proxy forwards the prefix.
    volumes:
      - kimai_public:/opt/kimai/public
      - kimai_var:/opt/kimai/var
    networks:
      - proxy_net
      - default

  # Nextcloud (files)
  nextcloud-db:
    image: mariadb:10.11
    container_name: art-institut-nextcloud-db
    restart: unless-stopped
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    environment:
      - MYSQL_ROOT_PASSWORD=${NEXTCLOUD_DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=${NEXTCLOUD_DB_NAME}
      - MYSQL_USER=${NEXTCLOUD_DB_USER}
      - MYSQL_PASSWORD=${NEXTCLOUD_DB_PASSWORD}
    volumes:
      - nextcloud_db_data:/var/lib/mysql

  nextcloud:
    image: nextcloud:apache
    container_name: art-institut-nextcloud
    restart: unless-stopped
    depends_on:
      - nextcloud-db
      - redis
    environment:
      - MYSQL_HOST=nextcloud-db
      - MYSQL_DATABASE=${NEXTCLOUD_DB_NAME}
      - MYSQL_USER=${NEXTCLOUD_DB_USER}
      - MYSQL_PASSWORD=${NEXTCLOUD_DB_PASSWORD}
      - NEXTCLOUD_TRUSTED_DOMAINS=nextcloud.art-institut.de nc.art-institut.de
      - OVERWRITEHOST=nextcloud.art-institut.de
      - OVERWRITEPROTOCOL=https
      - APACHE_DISABLE_REWRITE_IP=1
    volumes:
      - nextcloud_data:/var/www/html
    networks:
      - proxy_net
      - default

  redis:
    image: redis:7-alpine
    container_name: art-institut-redis
    restart: unless-stopped
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD}"]
    volumes:
      - redis_data:/data
    networks:
      - default

  turn:
    image: coturn/coturn:latest
    container_name: art-institut-turn
    restart: unless-stopped
    command:
      - turnserver
      - --listening-port=3478
      - --listening-ip=0.0.0.0
      - --external-ip=${TURN_PUBLIC_IP}
      - --min-port=${TURN_MIN_PORT}
      - --max-port=${TURN_MAX_PORT}
      - --realm=${TURN_REALM}
      - --use-auth-secret
      - --static-auth-secret=${TURN_SHARED_SECRET}
      - --stale-nonce
      - --fingerprint
      - --cert=/certs/turn/fullchain.pem
      - --pkey=/certs/turn/privkey.pem
      - --tls-listening-port=5349
      - --log-file=stdout
    ports:
      - "3478:3478"
      - "3478:3478/udp"
      - "5349:5349"
      - "5349:5349/udp"
      - "${TURN_MIN_PORT}-${TURN_MAX_PORT}:${TURN_MIN_PORT}-${TURN_MAX_PORT}/udp"
    volumes:
      - ${TURN_CERT_PATH}:/certs/turn/fullchain.pem:ro
      - ${TURN_KEY_PATH}:/certs/turn/privkey.pem:ro

volumes:
  kimai_db_data: {}
  kimai_public: {}
  kimai_var: {}
  nextcloud_db_data: {}
  nextcloud_data: {}
  redis_data: {}

networks:
  proxy_net:
    external: true
